{% extends "base.html" %}
{% load static %}

{% block title %}Mapa Turístic{% endblock %}

{% block content %}
<h2>Explora llocs turístics</h2>

<div class="cercador-ciutat">
    <label for="city">Escriu una ciutat:</label>
    <input type="text" id="city" placeholder="Ex: Roma, París, Barcelona" />
    <button onclick="searchCity()">Cercar</button>
</div>

<div id="map"></div>

<style>
    #map {
        height: 80vh;
        width: 100%;
        margin-top: 1rem;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .cercador-ciutat {
        margin-bottom: 1rem;
    }

    .cercador-ciutat input,
    .cercador-ciutat button {
        padding: 0.5rem;
        margin-right: 0.5rem;
    }
</style>

<!-- Leaflet CSS i JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let cityMarker;
    let poiMarkers = [];

    function initMap() {
        map = L.map('map').setView([41.3851, 2.1734], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Força que es redibuixi correctament
        setTimeout(() => {
            map.invalidateSize();
        }, 300);
    }

    function searchCity() {
        const city = document.getElementById('city').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    map.setView([lat, lon], 13);

                    if (cityMarker) map.removeLayer(cityMarker);
                    cityMarker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${display_name}</b>`).openPopup();

                    clearPoiMarkers();
                    loadTouristSpots(lat, lon);
                } else {
                    alert("No s'ha trobat la ciutat.");
                }
            });
    }

    function loadTouristSpots(lat, lon) {
        const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node(around:3000,${lat},${lon})[tourism~"attraction|museum|viewpoint"];out;`;

        fetch(overpassUrl)
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const name = el.tags.name || 'Lloc turístic';
                    const marker = L.marker([el.lat, el.lon]).addTo(map)
                        .bindPopup(`<b>${name}</b>`);
                    poiMarkers.push(marker);
                });
            });
    }

    function clearPoiMarkers() {
        poiMarkers.forEach(m => map.removeLayer(m));
        poiMarkers = [];
    }

    // Quan es carregui el DOM, inicialitzem el mapa
    window.addEventListener('DOMContentLoaded', () => {
        initMap();
    });
</script>
{% endblock %}
