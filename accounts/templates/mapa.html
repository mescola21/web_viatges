{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>Explora llocs turístics</h2>

<div class="cercador-ciutat">
    <label for="city">Escriu una ciutat:</label>
    <input type="text" id="city" placeholder="Ex: Roma, París, Barcelona" />
    <button onclick="searchCity()">Cercar</button>
</div>

<div id="map"></div>

<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

#map {
    height: 100vh; /* 100% de l'alçada de la finestra */
    width: 100%;   /* Ocupa tota l'amplada */
    margin-top: 1rem;
    border: 1px solid #ccc;
    border-radius: 8px;
}

.cercador-ciutat {
    margin-bottom: 1rem;
}

.cercador-ciutat input,
.cercador-ciutat button {
    padding: 0.5rem;
    margin-right: 0.5rem;
}
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map = L.map('map').setView([41.3851, 2.1734], 13);
    let cityMarker;
    let poiMarkers = [];

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Redimensionar mapa quan canvia la mida de la finestra
    map.invalidateSize();

    function searchCity() {
        const city = document.getElementById('city').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    map.setView([lat, lon], 13);

                    if (cityMarker) map.removeLayer(cityMarker);
                    cityMarker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${display_name}</b>`).openPopup();

                    clearPoiMarkers();
                    loadTouristSpots(lat, lon);
                } else {
                    alert("No s'ha trobat la ciutat.");
                }
            });
    }

    function loadTouristSpots(lat, lon) {
        const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node(around:3000,${lat},${lon})[tourism~"attraction|museum|viewpoint"];out;`;

        fetch(overpassUrl)
            .then(res => res.json())
            .then(data => {
                data.elements.forEach(el => {
                    const name = el.tags.name || 'Lloc turístic';
                    const marker = L.marker([el.lat, el.lon]).addTo(map)
                        .bindPopup(`<b>${name}</b>`);
                    poiMarkers.push(marker);
                });
            });
    }

    function clearPoiMarkers() {
        poiMarkers.forEach(m => map.removeLayer(m));
        poiMarkers = [];
    }
</script>
{% endblock %}
